- resource: "https://site.web.api.espn.com/apis/v2/sports/soccer/eng.1/standings?region=uk&lang=en"
  scan_interval: 9000
  timeout: 5
  sensor:
    - name: "Liverpool (Premier League Position)"
      unique_id: "liverpool_premier_league_position_sensor"
      value_template: >
        {% set children = value_json.get('children', []) %}
        {% set entries = (children[0].standings.entries if children and children[0].get('standings') else []) %}
        {% set total_games = 38 %}
        {% set liverpool = entries | selectattr('team.displayName', 'equalto', 'Liverpool') | list | first %}

        {% if liverpool %}
          {% set lfc_points = liverpool['stats'] | selectattr('name', 'equalto', 'points') | map(attribute='value') | list | first | int %}
          {% set lfc_played = liverpool['stats'] | selectattr('name', 'equalto', 'gamesPlayed') | map(attribute='value') | list | first | int %}
          {% set lfc_gd = liverpool['stats'] | selectattr('name','equalto','pointDifferential') | map(attribute='value') | list | first | int %}
          {% set rank = liverpool['stats'] | selectattr('name', 'equalto', 'rank') | map(attribute='value') | list | first | int %}

          {% set suffix =
            'th' if rank in [11, 12, 13] else
            'st' if rank % 10 == 1 else
            'nd' if rank % 10 == 2 else
            'rd' if rank % 10 == 3 else
            'th' %}

          {% if rank == 1 %}
            {% set ns = namespace(uncatchable=true) %}
            {% for team in entries if team.team.displayName != 'Liverpool' %}
              {% set pts = team['stats'] | selectattr('name', 'equalto', 'points') | map(attribute='value') | list | first | int %}
              {% set played = team['stats'] | selectattr('name', 'equalto', 'gamesPlayed') | map(attribute='value') | list | first | int %}
              {% set max_possible = pts + (total_games - played) * 3 %}
              {% if max_possible > lfc_points %}
                {% set ns.uncatchable = false %}
              {% endif %}
            {% endfor %}

            {% if ns.uncatchable %}
              {{ rank }}{{ suffix }} (Champions)
            {% else %}
              {% set runner_up = (
                entries
                | rejectattr('team.displayName','equalto','Liverpool')
                | sort(attribute='stats' | selectattr('name', 'equalto', 'points') | map(attribute='value') | list | first, reverse=true)
                | first
              ) %}
              {% set runner_points = runner_up['stats'] | selectattr('name','equalto','points') | map(attribute='value') | list | first | int %}
              {% set runner_gd = runner_up['stats'] | selectattr('name','equalto','pointDifferential') | map(attribute='value') | list | first | int %}

              {% if lfc_points == runner_points %}
                {{ rank }}{{ suffix }} (+{{ lfc_gd - runner_gd }} GD)
              {% else %}
                {{ rank }}{{ suffix }} (+{{ lfc_points - runner_points }} pts)
              {% endif %}
            {% endif %}
          {% else %}
            {% set leader = (
              entries
              | rejectattr('team.displayName','equalto','Liverpool')
              | sort(attribute='stats' | selectattr('name', 'equalto', 'points') | map(attribute='value') | list | first, reverse=true)
              | first
            ) %}
            {% set leader_points = leader['stats'] | selectattr('name','equalto','points') | map(attribute='value') | list | first | int %}
            {% set leader_gd = leader['stats'] | selectattr('name','equalto','pointDifferential') | map(attribute='value') | list | first | int %}

            {% if leader_points == lfc_points %}
              {{ rank }}{{ suffix }} (-{{ leader_gd - lfc_gd }} GD)
            {% else %}
              {{ rank }}{{ suffix }} (-{{ leader_points - lfc_points }} pts)
            {% endif %}
          {% endif %}
        {% else %}
          Liverpool not found
        {% endif %}


