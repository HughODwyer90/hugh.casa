esphome:
  name: pressure
  friendly_name: Pressure
  compile_process_limit: 1

esp32:
  board: esp32dev
  framework:
    type: arduino

logger:
  level: DEBUG
  logs:
    esp32_ble_tracker: DEBUG
    ble_dump: DEBUG
    ble_toothbrush: DEBUG
    esp32_ble_client: DEBUG

wifi:
  ssid: !secret wifi_ssid
  power_save_mode: NONE
  password: !secret wifi_password
  manual_ip:
    static_ip: 192.168.0.201
    gateway: 192.168.0.1
    subnet: 255.255.255.0

ota:
  platform: esphome

api:
  encryption:
    key: !secret pressure_api

esp32_ble_tracker:
  on_ble_advertise:
    - mac_address: 24:E5:AA:5C:A8:A0
      then:
        - lambda: |-
            ESP_LOGD("ble_toothbrush", "==== TOOTHBRUSH ADV ====");
            ESP_LOGD("ble_toothbrush", "  Address: %s", x.address_str().c_str());
            ESP_LOGD("ble_toothbrush", "  RSSI: %d", x.get_rssi());

            if (!x.get_name().empty()) {
              ESP_LOGD("ble_toothbrush", "  Name: %s", x.get_name().c_str());
            }

            for (const auto &m : x.get_manufacturer_datas()) {
              std::string md = "  Manufacturer data:";
              for (auto byte : m.data) {
                char buf[5];
                snprintf(buf, sizeof(buf), " %02X", byte);
                md += buf;
              }
              ESP_LOGD("ble_toothbrush", "%s", md.c_str());
            }

            for (const auto &uuid : x.get_service_uuids()) {
              ESP_LOGD("ble_toothbrush", "  Service UUID: %s", uuid.to_string().c_str());
            }

            for (const auto &sd : x.get_service_datas()) {
              std::string sd_str = "  Service data (" + sd.uuid.to_string() + "):";
              for (auto byte : sd.data) {
                char buf[5];
                snprintf(buf, sizeof(buf), " %02X", byte);
                sd_str += buf;
              }
              ESP_LOGD("ble_toothbrush", "%s", sd_str.c_str());
            }

            ESP_LOGD("ble_toothbrush", "--------------------------");

ble_client:
  - id: toothbrush_client
    mac_address: 24:E5:AA:5C:A8:A0

sensor:
  - platform: ble_rssi
    mac_address: "24:E5:AA:5C:A8:A0"
    name: "Toothbrush RSSI"
    device_class: signal_strength
    unit_of_measurement: "dBm"
    state_class: measurement
    filters:
      - throttle: 5s

  - platform: ble_client
    type: characteristic
    ble_client_id: toothbrush_client
    service_uuid: "180F"
    characteristic_uuid: "2A19"
    name: "Toothbrush Battery"
    device_class: battery
    unit_of_measurement: "%"
    state_class: measurement
    update_interval: 60s

  - platform: ble_client
    type: characteristic
    ble_client_id: toothbrush_client
    service_uuid: "477EA600-A260-11E4-AE37-0002A5D50001"
    characteristic_uuid: "477EA600-A260-11E4-AE37-0002A5D54020"
    name: "Sonicare Custom Value 1"
    update_interval: 10s

binary_sensor:
  - platform: gpio
    pin:
      number: 13
      inverted: true
      mode: INPUT_PULLUP
    name: Rug Sensor
    device_class: occupancy
    filters:
      - delayed_on: 0s
      - delayed_off: 5s

  - platform: gpio
    pin:
      number: 15
      inverted: true
      mode: INPUT_PULLUP
    name: Bed Sensor
    device_class: occupancy
    filters:
      - delayed_on: 2s
      - delayed_off: 2s

  - platform: ble_presence
    mac_address: "24:E5:AA:5C:A8:A0"
    name: "Toothbrush"
    timeout: 60s

  - platform: template
    name: "Sonicare Notify Flag"
    lambda: 'return false;'

text_sensor:
  - platform: ble_client
    ble_client_id: toothbrush_client
    service_uuid: "477EA600-A260-11E4-AE37-0002A5D50001"
    characteristic_uuid: "477EA600-A260-11E4-AE37-0002A5D54010"
    name: "Char 54010"
    update_interval: 30s
    on_value:
      then:
        - lambda: |-
            std::string hex_str = "HEX Char 54010:";
            for (auto b : x) {
              char buf[5];
              snprintf(buf, sizeof(buf), " %02X", b);
              hex_str += buf;
            }
            ESP_LOGI("ble_toothbrush", "%s", hex_str.c_str());

  - platform: ble_client
    ble_client_id: toothbrush_client
    service_uuid: "477EA600-A260-11E4-AE37-0002A5D50001"
    characteristic_uuid: "477EA600-A260-11E4-AE37-0002A5D54020"
    name: "Char 54020"
    update_interval: 30s
    on_value:
      then:
        - lambda: |-
            std::string hex_str = "HEX Char 54020:";
            for (auto b : x) {
              char buf[5];
              snprintf(buf, sizeof(buf), " %02X", b);
              hex_str += buf;
            }
            ESP_LOGI("ble_toothbrush", "%s", hex_str.c_str());

  - platform: ble_client
    ble_client_id: toothbrush_client
    service_uuid: "477EA600-A260-11E4-AE37-0002A5D50001"
    characteristic_uuid: "477EA600-A260-11E4-AE37-0002A5D54022"
    name: "Char 54022"
    update_interval: 30s
    on_value:
      then:
        - lambda: |-
            std::string hex_str = "HEX Char 54022:";
            for (auto b : x) {
              char buf[5];
              snprintf(buf, sizeof(buf), " %02X", b);
              hex_str += buf;
            }
            ESP_LOGI("ble_toothbrush", "%s", hex_str.c_str());

  - platform: ble_client
    ble_client_id: toothbrush_client
    service_uuid: "477EA600-A260-11E4-AE37-0002A5D50001"
    characteristic_uuid: "477EA600-A260-11E4-AE37-0002A5D54040"
    name: "Char 54040"
    update_interval: 30s
    on_value:
      then:
        - lambda: |-
            std::string hex_str = "HEX Char 54040:";
            for (auto b : x) {
              char buf[5];
              snprintf(buf, sizeof(buf), " %02X", b);
              hex_str += buf;
            }
            ESP_LOGI("ble_toothbrush", "%s", hex_str.c_str());

  - platform: ble_client
    ble_client_id: toothbrush_client
    service_uuid: "477EA600-A260-11E4-AE37-0002A5D50001"
    characteristic_uuid: "477EA600-A260-11E4-AE37-0002A5D54050"
    name: "Char 54050"
    update_interval: 30s
    on_value:
      then:
        - lambda: |-
            std::string hex_str = "HEX Char 54050:";
            for (auto b : x) {
              char buf[5];
              snprintf(buf, sizeof(buf), " %02X", b);
              hex_str += buf;
            }
            ESP_LOGI("ble_toothbrush", "%s", hex_str.c_str());
